name: Build & Test

permissions:
  contents: write

on:
  push:
    branches:
      - master
      - develop
      - feature/**
    tags:
      - 'v*'
  pull_request:
    branches:
      - master
      - develop
  workflow_dispatch:

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      - name: Install system dependencies (Ubuntu)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgl1-mesa-dev \
            libxcursor-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxi-dev \
            libxxf86vm-dev \
            libxext-dev \
            libxrandr-dev \
            pkg-config
      
      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      
      - name: Download dependencies
        run: go mod download
      
      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.out
          flags: unittests
          name: codecov-umbrella

  build-cli:
    name: Build CLI
    needs: test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: windows
            goarch: amd64
            artifact_name: data-leak-locator.exe
          - goos: darwin
            goarch: amd64
            artifact_name: data-leak-locator-macos-amd64
          - goos: darwin
            goarch: arm64
            artifact_name: data-leak-locator-macos-m1
          - goos: linux
            goarch: amd64
            artifact_name: data-leak-locator-linux
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      
      - name: Build CLI
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          mkdir -p build
          go build -o build/${{ matrix.artifact_name }} -v ./
      
      - name: Upload CLI artifact
        uses: actions/upload-artifact@v4
        with:
          name: cli-${{ matrix.goos }}-${{ matrix.goarch }}
          path: build/${{ matrix.artifact_name }}
          retention-days: 7

  build-gui:
    name: Build GUI
    needs: test
    runs-on: ${{ matrix.runs-on }}
    strategy:
      matrix:
        include:
          - goos: windows
            goarch: amd64
            runs-on: windows-latest
            artifact_name: data-leak-locator-gui.exe
          - goos: darwin
            goarch: amd64
            runs-on: macos-14
            artifact_name: data-leak-locator-gui-macos-amd64
          - goos: darwin
            goarch: arm64
            runs-on: macos-14
            artifact_name: data-leak-locator-gui-macos-m1
          - goos: linux
            goarch: amd64
            runs-on: ubuntu-latest
            artifact_name: data-leak-locator-gui-linux
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgl1-mesa-dev \
            libxcursor-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxi-dev \
            libxxf86vm-dev \
            libxext-dev \
            libx11-dev \
            pkg-config
      
      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
            ${{ env.LOCALAPPDATA }}\go-build
            ${{ env.ProgramData }}\chocolatey\lib\golang\tools\go\pkg
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      
      - name: Download dependencies
        run: go mod download
      
      - name: Build GUI (native compilation only)
        timeout-minutes: 30
        env:
          GOFLAGS: -v
        run: |
          mkdir -p build
          cd cmd/gui
          echo "Starting GUI build..."
          go build -o ../../build/${{ matrix.artifact_name }} -v .
          echo "GUI build completed successfully"
      
      - name: Upload GUI artifact
        uses: actions/upload-artifact@v4
        with:
          name: gui-${{ matrix.goos }}-${{ matrix.goarch }}
          path: build/${{ matrix.artifact_name }}
          retention-days: 7

  create-release:
    name: Create Release (on tag)
    needs: [ build-cli, build-gui ]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            cli-windows-amd64/data-leak-locator.exe
            cli-darwin-amd64/data-leak-locator-macos-amd64
            cli-darwin-arm64/data-leak-locator-macos-m1
            cli-linux-amd64/data-leak-locator-linux
            gui-windows-amd64/data-leak-locator-gui.exe
            gui-darwin-amd64/data-leak-locator-gui-macos-amd64
            gui-darwin-arm64/data-leak-locator-gui-macos-m1
            gui-linux-amd64/data-leak-locator-gui-linux
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
